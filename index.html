<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Visitor Scanner | Maxion Automation</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --primary:#0a7d2c;
  --secondary:#111;
  --bg:#f4f6f8;
  --card:#fff;
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
}

header{
  background:var(--secondary);
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:18px;
  font-weight:bold;
}

.container{
  padding:10px;
  max-width:900px;
  margin:auto;
}

.card{
  background:var(--card);
  padding:12px;
  border-radius:8px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

h3{
  margin-top:0;
  color:var(--primary);
}

#reader{
  width:300px;
  margin:auto;
}

pre{
  background:#eee;
  padding:8px;
  font-size:12px;
  max-height:140px;
  overflow:auto;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:10px;
  border-radius:6px;
  margin:4px 2px;
  font-size:14px;
  cursor:pointer;
}

button.secondary{
  background:#444;
}

button.small{
  padding:6px 8px;
  font-size:12px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:left;
}

th{
  background:#eaeaea;
}

.actions button{
  margin:2px;
}

.footer{
  text-align:center;
  font-size:11px;
  color:#666;
  margin-top:10px;
}
</style>
</head>

<body>

<header>
Maxion Automation Pvt Ltd – Visitor Lead Scanner
</header>

<div class="container">

<!-- SCANNER -->
<div class="card">
<h3>Scan Visitor QR</h3>
<div id="reader"></div>
</div>

<!-- RAW DATA -->
<div class="card">
<h3>Scanned vCard</h3>
<pre id="raw">Waiting for scan…</pre>
</div>

<!-- ENQUIRY -->
<div class="card">
<h3>Enquiry</h3>
<label><input type="radio" name="enquiry" value="Yes"> Yes</label>
<label style="margin-left:10px;">
<input type="radio" name="enquiry" value="No" checked> No
</label>
</div>

<!-- PHOTO -->
<div class="card">
<h3>Photo with Director (optional)</h3>
<input type="file" accept="image/*" capture="camera">
<p style="font-size:12px;color:#666;">(Attach manually in WhatsApp)</p>
</div>

<!-- ACTION BUTTONS -->
<div class="card">
<div class="row">
<button onclick="sendWhatsApp()">Send WhatsApp</button>
<button onclick="sendEmail()">Send Email</button>
<button class="secondary" onclick="saveVisitor()">Save to History</button>
</div>
</div>

<!-- DATA MANAGEMENT -->
<div class="card">
<h3>Data Management</h3>
<div class="row">
<button onclick="downloadExcel()">Download Excel</button>
<button onclick="backupData()">Backup</button>
<label class="secondary">
Restore
<input type="file" accept=".json" style="display:none" onchange="restoreData(event)">
</label>
</div>
</div>

<!-- HISTORY -->
<div class="card">
<h3>Saved Visitors</h3>
<table>
<thead>
<tr>
<th>Time</th>
<th>Name</th>
<th>Org</th>
<th>Phone</th>
<th>Email</th>
<th>Enquiry</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div class="footer">
Offline Plan A • Multi-phone • Excel merge supported
</div>

</div>

<script>
let scannedVcard="";
let visitors=JSON.parse(localStorage.getItem("visitors")||"[]");

// QR
new Html5QrcodeScanner("reader",{fps:10,qrbox:250})
.render(txt=>{
  scannedVcard=txt;
  document.getElementById("raw").innerText=txt;
});

// Utils
function enquiryVal(){
  return [...document.getElementsByName("enquiry")]
  .find(r=>r.checked)?.value||"No";
}

function parseVCard(v){
  const g=r=>(v.match(r)||["",""])[1].trim();
  return{
    time:new Date().toLocaleString(),
    name:g(/FN:(.*)/),
    org:g(/ORG:(.*)/),
    phone:g(/TEL.*:(.*)/),
    email:g(/EMAIL.*:(.*)/),
    enquiry:enquiryVal()
  };
}

// SAVE
function saveVisitor(){
  if(!scannedVcard) return alert("Scan QR first");
  const d=parseVCard(scannedVcard);
  if(visitors.some(v=>v.phone===d.phone && d.phone)){
    alert("Duplicate visitor");
    return;
  }
  visitors.push(d);
  localStorage.setItem("visitors",JSON.stringify(visitors));
  render();
  alert("Saved");
}

// RENDER
function render(){
  const t=document.getElementById("tableBody");
  t.innerHTML="";
  visitors.forEach(v=>{
    t.innerHTML+=`
    <tr>
      <td>${v.time}</td>
      <td>${v.name}</td>
      <td>${v.org}</td>
      <td>${v.phone}</td>
      <td>${v.email}</td>
      <td>${v.enquiry}</td>
      <td class="actions">
        <button class="small" onclick="waFromHistory('${v.phone}')">WA</button>
        <button class="small" onclick="mailFromHistory('${v.email}','${v.name}','${v.enquiry}')">Mail</button>
      </td>
    </tr>`;
  });
}
render();

// WHATSAPP
function sendWhatsApp(){
  if(!scannedVcard) return;
  const v=parseVCard(scannedVcard);
  const msg=`Hello ${v.name},

Thank you for visiting Maxion Automation Pvt Ltd.
${v.enquiry==="Yes"?"We noted your enquiry and will contact you shortly.":""}

Regards,
Maxion Automation Team`;
  window.open(`https://wa.me/91${v.phone}?text=${encodeURIComponent(msg)}`);
}

function waFromHistory(p){
  const v=visitors.find(x=>x.phone===p);
  if(!v) return;
  sendWhatsApp(v);
}

// EMAIL
function sendEmail(){
  if(!scannedVcard) return;
  const v=parseVCard(scannedVcard);
  openMail(v.email,v.name,v.enquiry);
}

function mailFromHistory(e,n,enq){
  openMail(e,n,enq);
}

function openMail(email,name,enq){
  const sub="Thank you for visiting Maxion Automation Pvt Ltd";
  const body=`Hello ${name},

Thank you for visiting Maxion Automation Pvt Ltd.
${enq==="Yes"?"We noted your enquiry and our team will reach out.":""}

Warm regards,
Maxion Automation Team`;
  window.location.href=`mailto:${email}?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`;
}

// EXCEL
function downloadExcel(){
  if(!visitors.length) return alert("No data");
  let csv="Time,Name,Organization,Phone,Email,Enquiry\n";
  visitors.forEach(v=>{
    csv+=`"${v.time}","${v.name}","${v.org}","${v.phone}","${v.email}","${v.enquiry}"\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="visitor_data_"+Date.now()+".csv";
  a.click();
}

// BACKUP
function backupData(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob(
    [JSON.stringify(visitors)],{type:"application/json"}
  ));
  a.download="visitor_backup.json";
  a.click();
}

// RESTORE
function restoreData(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=x=>{
    visitors=JSON.parse(x.target.result);
    localStorage.setItem("visitors",JSON.stringify(visitors));
    render();
    alert("Data restored");
  };
  r.readAsText(f);
}
</script>

</body>
</html>
